name: Build and Release Portfolio Manager (Simple)

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  
jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            extension: .exe
            icon: icon.ico
          - os: macos-latest
            platform: darwin
            extension: ""
            icon: icon.png
          - os: ubuntu-latest
            platform: linux
            extension: ""
            icon: icon.png

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libpango-1.0-0 libharfbuzz0b libpangoft2-1.0-0

    - name: Build executable
      run: |
        pyinstaller --onefile --windowed --name PortfolioManager-${{ matrix.platform }} --icon ${{ matrix.icon }} --collect-all flet --collect-all flet_core --hidden-import flet --hidden-import flet_core --hidden-import flet.fastapi --hidden-import websockets --hidden-import uvicorn --hidden-import starlette --hidden-import httpx --noconfirm main_flet.py

    - name: Set execute permissions for Linux
      if: matrix.os == 'ubuntu-latest'
      run: |
        chmod +x dist/PortfolioManager-${{ matrix.platform }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: PortfolioManager-${{ matrix.platform }}
        path: dist/PortfolioManager-${{ matrix.platform }}${{ matrix.extension }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: List downloaded files (debug)
      run: |
        echo "Downloaded artifacts:"
        find artifacts -type f -name "*" -exec ls -la {} \; || echo "No files found"
        echo "Directory structure:"
        tree artifacts/ || ls -la artifacts/ || echo "No artifacts directory"
        echo "Current directory:"
        pwd
        ls -la
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          artifacts/PortfolioManager-windows/PortfolioManager-windows.exe
          artifacts/PortfolioManager-darwin/PortfolioManager-darwin
          artifacts/PortfolioManager-linux/PortfolioManager-linux
        body: |
          ## üéâ Portfolio Document Manager ${{ github.ref_name }}
          
          ### ‚ú® Latest Updates - Enhanced User Experience
          
          Improved window sizing and user interface optimizations for better usability!
          
          ### üöÄ New Features & Improvements
          
          ‚Ä¢ üñ•Ô∏è Enhanced Window Size: Larger default window (1400x1200px) for better content display
          ‚Ä¢ üìè Improved Layout: Better spacing for portfolio tables and interface elements  
          ‚Ä¢ üéØ Tooltips System: Hover help for learning outcomes with descriptions and examples
          ‚Ä¢ üìù Radio Button Feedback: Single-selection feedback system for better data consistency
          ‚Ä¢ üìÖ Date/Time Display: Timestamps in feedback overview for better tracking
          ‚Ä¢ üåê Multi-language Support: Dutch/English language switching
          ‚Ä¢ üåô Dark/Light Mode: Toggle between themes
          ‚Ä¢ üì± Responsive Design: Adapts to different screen sizes
          
          ### üõ†Ô∏è Technical Improvements
          
          ‚Ä¢ Modern Flet Framework: Beautiful, cross-platform UI
          ‚Ä¢ Better Window Management: Improved default sizing and minimum constraints
          ‚Ä¢ Enhanced Navigation: Improved menu structure and user flow
          ‚Ä¢ Tooltip Integration: Contextual help throughout the application
          ‚Ä¢ Feedback System: Radio buttons for single-selection feedback
          ‚Ä¢ Cross-platform: Consistent experience across all OS platforms
          
          ### üìã Core Features
          
          ‚Ä¢ Portfolio Management: Add, edit, and organize portfolio items with tooltips
          ‚Ä¢ Feedback System: Track feedback per learning outcome with date/time stamps
          ‚Ä¢ Document Generation: Export to PDF and Markdown formats
          ‚Ä¢ Learning Outcomes: Detailed information with examples and tooltips
          ‚Ä¢ Student Data: Easy configuration management
          ‚Ä¢ Multi-language: Dutch and English interface support
          
          ### üì¶ Downloads
          
          Choose your platform:
          
          ‚Ä¢ Windows: `PortfolioManager-windows.exe`
          ‚Ä¢ macOS: `PortfolioManager-darwin`
          ‚Ä¢ Linux: `PortfolioManager-linux`
          
          ### üîß Installation
          
          1. Download the executable for your platform
          2. On macOS/Linux: `chmod +x PortfolioManager-*`
          3. Start the application
          
          ### üíª Development Notes
          
          ‚Ä¢ Main application: `main_flet.py`
          ‚Ä¢ Build script: `build.py`
          ‚Ä¢ Requirements: See `requirements.txt`
          ‚Ä¢ Desktop integration files included for Linux
          
          --------
          
          üîó Repository: https://github.com/RickMageddon/PortfolioDocumentManager
        draft: false
        prerelease: false
        fail_on_unmatched_files: false
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload build artifacts (for manual runs)
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: all-executables-combined
        path: artifacts/*/
